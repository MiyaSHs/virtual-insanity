# /etc/portage/bashrc - Golden Master dynamic tuning for selected targets
# This runs inside Portage build environments.
# It injects ThinLTO + SamplePGO (+ optional Propeller ordering) for configured targets only.

# shellcheck disable=SC1091
[[ -r /etc/gm-fdo-targets.conf ]] && source /etc/gm-fdo-targets.conf

GM_PROFILE_DIR="${GM_PROFILE_DIR:-/var/lib/gm/profiles}"

gm_is_target_atom() {
  local atom="$1"
  local entry
  for entry in "${GM_TARGETS[@]:-}"; do
    IFS='|' read -r _name _atom _bin _triggers <<<"$entry"
    if [[ "$_atom" == "$atom" ]]; then
      return 0
    fi
  done
  return 1
}

gm_apply_flags() {
  local atom="${CATEGORY}/${PN}"
  gm_is_target_atom "$atom" || return 0

  local key="${CATEGORY}-${PN}"
  local afdo="${GM_PROFILE_DIR}/${key}.afdo"
  local prop_cc="${GM_PROFILE_DIR}/${key}_propeller_cc_profile.txt"
  local prop_ld="${GM_PROFILE_DIR}/${key}_propeller_ld_profile.txt"

  # Baseline: high value flags for “big” targets
  # Note: -O3 is used only for targets, not globally.
  local extra="-O3 -gline-tables-only -fdebug-info-for-profiling -fno-omit-frame-pointer -flto=thin"

  # Safety rails for a few fragile atoms (keeps installer hands-free).
  case "$atom" in
    sys-libs/glibc)
      # glibc + clang + LTO is a frequent footgun; keep it conservative.
      extra="-O2 -gline-tables-only -fdebug-info-for-profiling -fno-omit-frame-pointer"
      ;;
  esac

  if [[ -f "$afdo" ]]; then
    extra+=" -fprofile-sample-use=${afdo}"
  fi

  # Propeller (cc+ld profiles). Optional and experimental.
  if [[ -f "$prop_cc" && -f "$prop_ld" ]]; then
    # lld supports --symbol-ordering-file
    export LDFLAGS="${LDFLAGS:-} -Wl,--symbol-ordering-file=${prop_ld}"
    extra+=" -fbasic-block-address-map -fbasic-block-sections=all -fpropeller-optimize=${prop_cc}"
  fi

  export CFLAGS="${CFLAGS:-} ${extra}"
  export CXXFLAGS="${CXXFLAGS:-} ${extra}"
}

gm_apply_flags || true
