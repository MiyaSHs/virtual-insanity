#!/usr/bin/env bash
set -euo pipefail

log() { echo "[gm-optimize] $*"; }

if [[ "${EUID:-$(id -u)}" -ne 0 ]]; then
  echo "Run as root (sudo gm-optimize)" >&2
  exit 1
fi

/usr/local/bin/gm-fdo-accumulate || true
/usr/local/bin/gm-portage-env-apply || true

if [[ -f /etc/portage/sets/gm-fdo-targets ]]; then
  if grep -q . /etc/portage/sets/gm-fdo-targets; then
    log "Rebuilding installed targets with latest profilesâ€¦"
    emerge --oneshot @gm-fdo-targets || true
  else
    log "No installed targets listed."
  fi
else
  log "No target set found."
fi

log "Done."
