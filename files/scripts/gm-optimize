#!/usr/bin/env bash
set -euo pipefail

log() { echo "[gm-optimize] $*"; }

if [[ "${EUID:-$(id -u)}" -ne 0 ]]; then
  echo "Run as root (sudo gm-optimize)" >&2
  exit 1

# Optional: pin @gm-fdo-targets so `emerge --depclean` won’t remove “leaf” targets.
# Enable by setting GM_PIN_TARGETS=1 in your environment or a config file.
if [[ "${GM_PIN_TARGETS:-0}" == "1" ]]; then
  WORLD_SETS="/var/lib/portage/world_sets"
  mkdir -p /var/lib/portage
  touch "$WORLD_SETS"
  grep -qxF "@gm-fdo-targets" "$WORLD_SETS" || echo "@gm-fdo-targets" >> "$WORLD_SETS"
  log "Pinned @gm-fdo-targets in ${WORLD_SETS}"
fi

fi

/usr/local/bin/gm-fdo-accumulate || true
/usr/local/bin/gm-portage-env-apply || true
/usr/local/bin/gm-java-tune || true

if [[ -f /etc/portage/sets/gm-fdo-targets ]]; then
  if grep -q . /etc/portage/sets/gm-fdo-targets; then
    log "Rebuilding installed targets with latest profiles…"
    emerge --oneshot @gm-fdo-targets || true
  else
    log "No installed targets listed."
  fi
else
  log "No target set found."
fi

log "Done."
