#!/usr/bin/env bash
set -euo pipefail

# Process-aware perf sampler.
# Records perf data only while target triggers are running.

[[ -r /etc/gm-fdo-targets.conf ]] && source /etc/gm-fdo-targets.conf

log() { echo "[gm-perf] $*"; }

need() { command -v "$1" >/dev/null 2>&1 || { echo "Missing $1" >&2; exit 1; }; }

need perf
need pgrep
need date

mkdir -p "${GM_PERF_DIR}/chunks"
chmod 700 "${GM_PERF_DIR}/chunks"

active_triggers() {
  local entry
  for entry in "${GM_TARGETS[@]:-}"; do
    IFS='|' read -r _name _atom _bin _triggers <<<"$entry"
    for t in $_triggers; do
      if pgrep -fa "$t" >/dev/null 2>&1; then
        echo "$t"
        return 0
      fi
    done
  done
  return 1
}

choose_perf_args() {
  # Prefer LBR/branch stacks when supported; fallback to dwarf.
  # LBR is CPU/PMU dependent; errors should fall back cleanly.
  local hz="${GM_PERF_SAMPLE_HZ}"
  local dur="${GM_PERF_DURATION_SEC}"
  local out="$1"

  # Try: cycles:u + branch stacks
  if perf record -q -o "$out" -F "$hz" -e cycles:u -j any,u -- sleep 1 >/dev/null 2>&1; then
    echo "-F ${hz} -e cycles:u -j any,u"
    return 0
  fi

  # Try: cycles:u + dwarf callgraph
  echo "-F ${hz} -e cycles:u --call-graph dwarf,16384"
}

while true; do
  if trig=$(active_triggers); then
    ts="$(date +%Y%m%d-%H%M%S)"
    out="${GM_PERF_DIR}/chunks/perf-${ts}.data"
    args="$(choose_perf_args "$out")"
    log "Trigger active (${trig}). Recording ${GM_PERF_DURATION_SEC}s to ${out}â€¦"
    # System-wide record for simplicity; limited to active window
    perf record -q -o "$out" $args -a -- sleep "${GM_PERF_DURATION_SEC}" || true
    # Optional compress
    if command -v zstd >/dev/null 2>&1; then
      zstd -q -f -1 "$out" -o "${out}.zst" && rm -f "$out" || true
    fi
  else
    sleep "${GM_PERF_IDLE_SEC}"
  fi
done
