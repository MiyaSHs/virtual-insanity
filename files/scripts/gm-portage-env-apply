#!/usr/bin/env bash
set -euo pipefail

name="${1:-}"
[[ -n "$name" ]] || exit 0

FDO_DIR="/etc/portage/fdo/${name}"
ENV_FILE="/etc/portage/env/gm-${name}"
PKGENV="/etc/portage/package.env"

mkdir -p /etc/portage/env

atoms=()
case "$name" in
  mesa) atoms=("media-libs/mesa") ;;
  gamescope) atoms=("gui-wm/gamescope") ;;
  kernel) atoms=("sys-kernel/gentoo-kernel" "sys-kernel/gentoo-kernel-bin") ;;
  *) atoms=() ;;
esac

installed_any=0
for a in "${atoms[@]}"; do
  if qlist -IC "$a" >/dev/null 2>&1; then installed_any=1; fi
done
[[ "$installed_any" -eq 1 ]] || exit 0

cat >"$ENV_FILE" <<EOF
# Generated by Golden Master
CC=clang
CXX=clang++
AR=llvm-ar
NM=llvm-nm
RANLIB=llvm-ranlib

CFLAGS="\${CFLAGS} -O3 -pipe -march=native -fuse-ld=lld"
CXXFLAGS="\${CXXFLAGS} -O3 -pipe -march=native -fuse-ld=lld"
LDFLAGS="\${LDFLAGS} -fuse-ld=lld"
EOF

if [[ -f "${FDO_DIR}/${name}.afdo" ]]; then
  echo "CFLAGS=\"\\${CFLAGS} -fprofile-sample-use=${FDO_DIR}/${name}.afdo\"" >>"$ENV_FILE"
  echo "CXXFLAGS=\"\\${CXXFLAGS} -fprofile-sample-use=${FDO_DIR}/${name}.afdo\"" >>"$ENV_FILE"
fi

if [[ -f "${FDO_DIR}/cluster.txt" && -f "${FDO_DIR}/symorder.txt" ]]; then
  echo "CFLAGS=\"\\${CFLAGS} -funique-internal-linkage-names -fbasic-block-sections=list=${FDO_DIR}/cluster.txt\"" >>"$ENV_FILE"
  echo "CXXFLAGS=\"\\${CXXFLAGS} -funique-internal-linkage-names -fbasic-block-sections=list=${FDO_DIR}/cluster.txt\"" >>"$ENV_FILE"
  echo "LDFLAGS=\"\\${LDFLAGS} -Wl,--symbol-ordering-file=${FDO_DIR}/symorder.txt -Wl,--no-warn-symbol-ordering\"" >>"$ENV_FILE"
fi

touch "$PKGENV"
for a in "${atoms[@]}"; do
  grep -q "^${a} " "$PKGENV" || echo "${a} gm-${name}" >> "$PKGENV"
done
