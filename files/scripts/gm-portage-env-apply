#!/usr/bin/env bash
set -euo pipefail

[[ -r /etc/gm-fdo-targets.conf ]] && source /etc/gm-fdo-targets.conf

log() { echo "[gm-env] $*"; }
need() { command -v "$1" >/dev/null 2>&1 || { echo "Missing $1" >&2; exit 1; }; }

need mkdir
mkdir -p /etc/portage/{env,package.env,sets}

# env file: ensures splitdebug for better mapping
cat > /etc/portage/env/gm-fdo.env <<'EOF'
FEATURES="${FEATURES} splitdebug"
EOF

installed_atoms() {
  if command -v qlist >/dev/null 2>&1; then
    qlist -IC 2>/dev/null || true
  else
    # fallback: parse world? best-effort
    awk '{print $1}' /var/lib/portage/world 2>/dev/null || true
  fi
}

is_installed() {
  local atom="$1"
  installed_atoms | grep -qx "$atom"
}

# Build mapping and set
: > /etc/portage/package.env/99-gm-fdo
: > /etc/portage/sets/gm-fdo-targets

for entry in "${GM_TARGETS[@]:-}"; do
  IFS='|' read -r name atom binglob triggers <<<"$entry"
  if is_installed "$atom"; then
    echo "${atom} gm-fdo.env" >> /etc/portage/package.env/99-gm-fdo
    echo "${atom}" >> /etc/portage/sets/gm-fdo-targets
  fi
done

log "Updated /etc/portage/package.env/99-gm-fdo and set gm-fdo-targets"
