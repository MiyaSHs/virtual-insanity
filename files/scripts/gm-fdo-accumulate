#!/usr/bin/env bash
set -euo pipefail

CONF="/etc/gm-fdo-targets.conf"
[[ -f "$CONF" ]] || { echo "Missing $CONF" >&2; exit 1; }

# shellcheck disable=SC1090
source "$CONF"

GM_PERF_DIR="${GM_PERF_DIR:-/var/lib/gm/perf}"
GM_PROFILE_DIR="${GM_PROFILE_DIR:-/var/lib/gm/profiles}"

mkdir -p "$GM_PERF_DIR/chunks" "$GM_PROFILE_DIR"

have_pkg() {
  command -v qlist >/dev/null 2>&1 && qlist -IC "$1" | grep -q "^$1$"
}

resolve_bin() {
  local glob="$1"
  # First match wins
  local m
  for m in $glob; do
    [[ -e "$m" ]] && { echo "$m"; return 0; }
  done
  return 1
}

merge_sample() {
  local dst="$1" new="$2"
  if [[ -f "$dst" ]]; then
    llvm-profdata merge -sample -o "${dst}.tmp" "$dst" "$new" && mv "${dst}.tmp" "$dst"
  else
    mv "$new" "$dst"
  fi
}

gen_kernel_afdo() {
  local vmlinux="$1" perfdata="$2" out="$3"
  # llvm-profgen can consume perf.data with LBR/branch-stack and emit extbinary sample profiles.
  llvm-profgen --kernel --binary="$vmlinux" --perfdata="$perfdata" -o "$out"
}

gen_userspace_afdo() {
  local bin="$1" perfdata="$2" out="$3"
  # Prefer create_llvm_prof when present; fallback to llvm-profgen.
  if command -v create_llvm_prof >/dev/null 2>&1; then
    create_llvm_prof --binary="$bin" --profile="$perfdata" --format=extbinary --out="$out"
  else
    llvm-profgen --binary="$bin" --perfdata="$perfdata" -o "$out"
  fi
}

gen_propeller() {
  local bin="$1" perfdata="$2" out_prefix="$3"
  command -v create_llvm_prof >/dev/null 2>&1 || return 0
  create_llvm_prof --binary="$bin" --profile="$perfdata" --format=propeller --out="$out_prefix"
}

for chunk in "$GM_PERF_DIR"/chunks/*.data; do
  [[ -s "$chunk" ]] || continue

  for entry in "${GM_TARGETS[@]}"; do
    IFS='|' read -r name atom binary_glob _triggers <<<"$entry"

    have_pkg "$atom" || continue

    if ! bin=$(resolve_bin "$binary_glob"); then
      continue
    fi

    key="${atom//\//-}"
    tmp_afdo=$(mktemp "${GM_PROFILE_DIR}/${key}.XXXXXX.afdo")

    if [[ "$name" == "kernel" || "$bin" == *vmlinux ]]; then
      gen_kernel_afdo "$bin" "$chunk" "$tmp_afdo" || { rm -f "$tmp_afdo"; continue; }
    else
      gen_userspace_afdo "$bin" "$chunk" "$tmp_afdo" || { rm -f "$tmp_afdo"; continue; }
    fi

    merge_sample "${GM_PROFILE_DIR}/${key}.afdo" "$tmp_afdo"

    # Propeller profiles (regenerated per chunk; no safe merging)
    gen_propeller "$bin" "$chunk" "${GM_PROFILE_DIR}/${key}_propeller" || true
  done

  rm -f "$chunk" || true
done

exit 0
