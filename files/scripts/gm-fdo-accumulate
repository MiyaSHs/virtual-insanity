#!/usr/bin/env bash
set -euo pipefail

[[ -r /etc/gm-fdo-targets.conf ]] && source /etc/gm-fdo-targets.conf

log() { echo "[gm-fdo] $*"; }
need() { command -v "$1" >/dev/null 2>&1 || { echo "Missing $1" >&2; exit 1; }; }

need llvm-profgen
need llvm-profdata

mkdir -p "${GM_PROFILE_DIR}" "${GM_PERF_DIR}/chunks" "${GM_PERF_DIR}/processed"
chmod 700 "${GM_PROFILE_DIR}" "${GM_PERF_DIR}/chunks" "${GM_PERF_DIR}/processed"

resolve_bin() {
  local glob="$1"
  # pick the newest match (helps when versioned .so changes)
  local f
  f=$(ls -1t $glob 2>/dev/null | head -n1 || true)
  [[ -n "$f" ]] || return 1
  realpath "$f" 2>/dev/null || echo "$f"
}

make_sample_profile() {
  local bin="$1" perfdata="$2" out="$3"
  # Use extbinary sample profile (good default for -fprofile-sample-use)
  llvm-profgen --binary="$bin" --perfdata="$perfdata" --format=extbinary --llvm-sample-profile="$out" >/dev/null 2>&1
}

merge_sample_profiles() {
  local base="$1" add="$2"
  if [[ -f "$base" ]]; then
    llvm-profdata merge -sample -output="${base}.tmp" "$base" "$add" >/dev/null 2>&1
    mv -f "${base}.tmp" "$base"
  else
    mv -f "$add" "$base"
  fi
}

try_propeller() {
  local bin="$1" perfdata="$2" key="$3"
  # Optional: create_llvm_prof (from AutoFDO) can emit Propeller-compatible ordering profiles.
  if command -v create_llvm_prof >/dev/null 2>&1; then
    local outdir="${GM_PROFILE_DIR}/${key}.propeller.d"
    mkdir -p "$outdir"
    create_llvm_prof --binary="$bin" --profile="$perfdata" --format=propeller --out="$outdir" >/dev/null 2>&1 || return 0
    # Try to find a reasonable ordering file to feed lld
    local cand
    cand=$(ls -1 "$outdir"/*.txt 2>/dev/null | head -n1 || true)
    if [[ -n "$cand" ]]; then
      ln -sf "$cand" "${GM_PROFILE_DIR}/${key}.propeller.txt"
    fi
  fi
}

process_one_chunk() {
  local chunk="$1"
  local perfdata="$chunk"
  if [[ "$chunk" == *.zst ]]; then
    need zstd
    perfdata="${chunk%.zst}"
    zstd -q -d -f "$chunk" -o "$perfdata"
  fi

  local entry
  for entry in "${GM_TARGETS[@]:-}"; do
    IFS='|' read -r name atom binglob triggers <<<"$entry"
    local key="${atom//\//-}"
    local bin
    if ! bin=$(resolve_bin "$binglob"); then
      continue
    fi

    local tmp
    tmp="$(mktemp --suffix=.prof)"
    if make_sample_profile "$bin" "$perfdata" "$tmp"; then
      local out="${GM_PROFILE_DIR}/${key}.afdo"
      merge_sample_profiles "$out" "$tmp"
      log "Merged profile: $out (from $(basename "$chunk"))"
      try_propeller "$bin" "$perfdata" "$key" || true
    else
      rm -f "$tmp" || true
    fi
  done

  # Move chunk to processed
  mv -f "$chunk" "${GM_PERF_DIR}/processed/" || true
  [[ "$perfdata" != "$chunk" ]] && rm -f "$perfdata" || true
}

shopt -s nullglob
chunks=( "${GM_PERF_DIR}/chunks/"perf-*.data* )
if [[ ${#chunks[@]} -eq 0 ]]; then
  log "No chunks to process."
  exit 0
fi

for c in "${chunks[@]}"; do
  process_one_chunk "$c" || true
done

log "Accumulation complete."
